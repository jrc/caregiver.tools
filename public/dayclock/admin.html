<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dementia Day Clock Admin - Caregiver.tools</title>
        <link rel="stylesheet" href="../style.css" />
        <style>
            input[type="text"],
            textarea {
                font-size: 1rem;
                padding: 0.5rem;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <nav>
            <a href="../">Caregiver.tools</a> -
            <a href="./">Dementia Day Clock</a>
        </nav>

        <main>
            <h1>Admin Page</h1>

            <p>
                Bookmark this page! This is the only way that you, the
                caregiver, can customize your Dementia Day Clock later. There
                are no user accounts or passwords.
            </p>

            <h2>Manage Your Clock</h2>

            <label for="message-input">Custom Message:</label>
            <textarea
                id="message-input"
                placeholder="e.g. Your doctor's appointment is {{Date:2025-07-01}}."
            ></textarea>
            <p>
                You can write <tt>{{Date:YYYY-MM-DD}}</tt> with a future date
                and it will be shown in natural language, such as "tomorrow" or
                "in 5 days".
            </p>

            <button id="save-message-btn">Primary</button>
            <div id="status-message"></div>
        </main>

        <script src="script.js"></script>
        <script>
            (function () {
                "use strict";

                // --- DOM Elements ---
                const messageInput = document.getElementById("message-input");
                const saveMessageBtn =
                    document.getElementById("save-message-btn");
                const statusMessage = document.getElementById("status-message");

                /**
                 * Displays a status message to the user.
                 * @param {string} text - The message to display.
                 * @param {boolean} isError - True if the message is an error.
                 */
                function showStatus(text, isError = false) {
                    statusMessage.textContent = text;
                    statusMessage.className = isError
                        ? "alert alert-warning"
                        : "alert alert-success";
                    statusMessage.style.display = "block";
                }

                /**
                 * Fetches the current message and populates the input field.
                 * @param {string} clockId - The ID of the clock.
                 */
                async function loadCurrentMessage(clockId) {
                    if (!clockId) return;
                    try {
                        const data =
                            await window.CaregiverTools.fetchCurrentMessage(
                                clockId
                            );
                        if (data) {
                            messageInput.value = data.message || "";
                        } else {
                            messageInput.value = ""; // No message set yet
                        }
                    } catch (error) {
                        console.error("Error loading current message:", error);
                        showStatus(
                            "Could not retrieve the current message.",
                            true
                        );
                    }
                }

                /**
                 * Saves the message to the backend.
                 */
                async function saveMessage(clockIdToSave) {
                    const message = messageInput.value.trim();

                    if (!clockIdToSave) {
                        showStatus("Clock ID cannot be empty.", true);
                        return;
                    }

                    saveMessageBtn.disabled = true;
                    saveMessageBtn.textContent = "Sending...";
                    statusMessage.style.display = "none";

                    try {
                        const response = await fetch(
                            window.CaregiverTools.API_ENDPOINT,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    clock_id: clockIdToSave,
                                    message: message,
                                    imageUrl: null // For future use
                                })
                            }
                        );

                        if (!response.ok) {
                            throw new Error(
                                `Server responded with status: ${response.status}`
                            );
                        }
                        const data = await response.json();
                        showStatus(
                            "Saved. The Dementia Day Clock can take several minutes to update.",
                            false
                        );
                    } catch (error) {
                        console.error("Error saving message:", error);
                        showStatus("Unable to save.", true);
                    } finally {
                        saveMessageBtn.disabled = false;
                        saveMessageBtn.textContent = "Submit";
                    }
                }

                // --- Initial Page Load ---

                // Check for an id in the URL
                const urlParams = new URLSearchParams(window.location.search);
                let clockIdFromUrl = urlParams.get("id");

                // If no ID is present, redirect to the main page to generate one
                if (!clockIdFromUrl) {
                    window.location.replace("index.html"); // Redirect to the main page
                    return; // Stop execution
                }

                // Fetch message for the ID from the URL
                loadCurrentMessage(clockIdFromUrl);

                // Save Message button now takes the clockId directly
                saveMessageBtn.addEventListener("click", () =>
                    saveMessage(clockIdFromUrl)
                );
            })();
        </script>
    </body>
</html>
