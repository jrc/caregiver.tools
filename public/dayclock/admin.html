<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dementia Day Clock Admin - Caregiver.tools</title>
        <style>
            body {
                font-family: system-ui, sans-serif;
                max-width: 640px;
                margin: 2rem auto;
                line-height: 1.6;
            }
            h1,
            h2 {
                color: #333;
            }
            .input-group {
                margin-bottom: 1rem;
            }
            label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: bold;
            }
            input[type="text"],
            textarea {
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 1rem;
                box-sizing: border-box;
            }
            .clock-url-display {
                display: block;
                font-family: monospace;
                font-size: smaller;
                color: #555;
                padding: 0.5rem 0;
            }
            textarea {
                resize: vertical;
                min-height: 100px;
            }
            button {
                background-color: #007bff;
                color: white;
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            button:hover {
                background-color: #0056b3;
            }
            .urls {
                margin-top: 2rem;
                padding: 1rem;
                background-color: #f4f4f4;
                border-radius: 4px;
                word-wrap: break-word;
            }
            .status {
                margin-top: 1rem;
                padding: 0.75rem;
                border-radius: 4px;
                display: none;
            }
            .status.success {
                background-color: #d4edda;
                color: #155724;
            }
            .status.error {
                background-color: #f8d7da;
                color: #721c24;
            }
            #qrcode-display {
                margin-top: 1rem;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <h1>Dementia Day Clock - Admin Page</h1>

        <div id="manage-section">
            <h2>Manage Your Clock</h2>
            <p>
                Bookmark this page. You, the caregiver, will need this URL to
                remotely change the Day Clock message later.
            </p>
            <div class="admin-url-display">
                <label>Your Admin Page URL:</label>
                <span id="admin-url" class="clock-url-display"></span>
            </div>
            <div class="input-group">
                <label for="message-input">Message to Display</label>
                <textarea
                    id="message-input"
                    placeholder="e.g., Don't forget your doctor's appointment at 2 PM."
                ></textarea>
            </div>
            <button id="save-message-btn">Save Message</button>
            <div id="status-message" class="status"></div>
        </div>

        <script src="eff_short_wordlist_1.js"></script>
        <script src="script.js"></script>
        <script>
            (function () {
                "use strict";

                // --- DOM Elements ---
                const adminUrlDisplay = document.getElementById("admin-url"); // Renamed from clock-url, for admin page URL
                const messageInput = document.getElementById("message-input");
                const saveMessageBtn =
                    document.getElementById("save-message-btn");
                const statusMessage = document.getElementById("status-message");

                /**
                 * Displays a status message to the user.
                 * @param {string} text - The message to display.
                 * @param {boolean} isError - True if the message is an error.
                 */
                function showStatus(text, isError = false) {
                    statusMessage.textContent = text;
                    statusMessage.className = isError
                        ? "status error"
                        : "status success";
                    statusMessage.style.display = "block";
                }

                /**
                 * Fetches the current message and populates the input field.
                 * @param {string} clockId - The ID of the clock.
                 */
                async function loadCurrentMessage(clockId) {
                    if (!clockId) return;
                    try {
                        const data =
                            await window.CaregiverTools.fetchCurrentMessage(
                                clockId,
                            );
                        if (data) {
                            messageInput.value = data.message || "";
                        } else {
                            messageInput.value = ""; // No message set yet
                        }
                    } catch (error) {
                        console.error("Error loading current message:", error);
                        showStatus(
                            "Could not retrieve the current message.",
                            true,
                        );
                    }
                }

                /**
                 * Saves the message to the backend.
                 */
                async function saveMessage(clockIdToSave) {
                    const message = messageInput.value.trim();

                    if (!clockIdToSave) {
                        showStatus("Clock ID cannot be empty.", true);
                        return;
                    }

                    saveMessageBtn.disabled = true;
                    saveMessageBtn.textContent = "Saving...";
                    statusMessage.style.display = "none";

                    try {
                        const response = await fetch(
                            window.CaregiverTools.API_ENDPOINT,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    clock_id: clockIdToSave,
                                    message: message,
                                    imageUrl: null, // For future use
                                }),
                            },
                        );

                        if (!response.ok) {
                            throw new Error(
                                `Server responded with status: ${response.status}`,
                            );
                        }
                        const data = await response.json();
                        showStatus(
                            `Message saved successfully for "${data.clock_id}"!`,
                            false,
                        );
                    } catch (error) {
                        console.error("Error saving message:", error);
                        showStatus(
                            "Failed to save message. Please check the Clock ID and your connection.",
                            true,
                        );
                    } finally {
                        saveMessageBtn.disabled = false;
                        saveMessageBtn.textContent = "Save Message";
                    }
                }

                // --- Initial Page Load ---

                // Check for an id in the URL
                const urlParams = new URLSearchParams(window.location.search);
                let clockIdFromUrl = urlParams.get("id");

                // If no ID is present, redirect to the main page to generate one
                if (!clockIdFromUrl) {
                    window.location.replace("index.html"); // Redirect to the main page
                    return; // Stop execution
                }

                // Populate admin URL for bookmarking
                const fullAdminUrl = window.location.href;
                adminUrlDisplay.textContent = fullAdminUrl;

                // Fetch message for the ID from the URL
                loadCurrentMessage(clockIdFromUrl);

                // Save Message button now takes the clockId directly
                saveMessageBtn.addEventListener("click", () =>
                    saveMessage(clockIdFromUrl),
                );
            })();
        </script>
    </body>
</html>
